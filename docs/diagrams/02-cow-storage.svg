<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600" width="800" height="600">
  <defs>
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#60A5FA"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#34D399"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#F59E0B"/>
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="800" height="600" fill="#1F2937"/>
  
  <!-- Title -->
  <rect x="0" y="0" width="800" height="50" fill="url(#headerGrad)"/>
  <text x="400" y="32" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="white">Copy-on-Write (COW) Storage Architecture</text>
  
  <!-- User provides disk image -->
  <rect x="50" y="80" width="150" height="60" rx="8" fill="#3B82F6" filter="url(#shadow)"/>
  <text x="125" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">User Input</text>
  <text x="125" y="125" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#BFDBFE">File or URL</text>
  
  <!-- Arrow -->
  <path d="M200 110 L240 110" stroke="#60A5FA" stroke-width="2" marker-end="url(#arrow)"/>
  
  <!-- Base Device -->
  <rect x="250" y="70" width="200" height="80" rx="8" fill="#4B5563" filter="url(#shadow)"/>
  <text x="350" y="95" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Base Block Device</text>
  <text x="350" y="115" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#D1D5DB">FileBlockDevice</text>
  <text x="350" y="130" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#9CA3AF">or HttpBlockDevice</text>
  <text x="350" y="145" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#6B7280">(READ-ONLY)</text>
  
  <!-- The big COW Device -->
  <rect x="50" y="180" width="700" height="220" rx="12" fill="#374151" stroke="#F59E0B" stroke-width="2" filter="url(#shadow)"/>
  <text x="400" y="210" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#F59E0B">CowBlockDevice</text>
  
  <!-- Base inside COW -->
  <rect x="80" y="240" width="280" height="130" rx="8" fill="#1E3A5F"/>
  <text x="220" y="265" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#60A5FA">Base (Read-Only)</text>
  
  <!-- Disk blocks representation -->
  <rect x="100" y="285" width="40" height="30" fill="#3B82F6"/>
  <text x="120" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">0</text>
  <rect x="145" y="285" width="40" height="30" fill="#3B82F6"/>
  <text x="165" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">1</text>
  <rect x="190" y="285" width="40" height="30" fill="#3B82F6"/>
  <text x="210" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">2</text>
  <rect x="235" y="285" width="40" height="30" fill="#3B82F6"/>
  <text x="255" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">3</text>
  <rect x="280" y="285" width="40" height="30" fill="#3B82F6"/>
  <text x="300" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">...</text>
  
  <text x="220" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#93C5FD">Original disk image data</text>
  
  <!-- Overlay inside COW -->
  <rect x="420" y="240" width="300" height="130" rx="8" fill="#422006"/>
  <text x="570" y="265" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#F59E0B">Overlay (IndexedDB)</text>
  
  <!-- Sparse blocks -->
  <rect x="440" y="285" width="40" height="30" fill="#6B7280" stroke="#F59E0B" stroke-dasharray="3,2"/>
  <text x="460" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#9CA3AF">-</text>
  <rect x="485" y="285" width="40" height="30" fill="#F59E0B"/>
  <text x="505" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">1</text>
  <rect x="530" y="285" width="40" height="30" fill="#6B7280" stroke="#F59E0B" stroke-dasharray="3,2"/>
  <text x="550" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#9CA3AF">-</text>
  <rect x="575" y="285" width="40" height="30" fill="#F59E0B"/>
  <text x="595" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">3</text>
  <rect x="620" y="285" width="40" height="30" fill="#6B7280" stroke="#F59E0B" stroke-dasharray="3,2"/>
  <text x="640" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#9CA3AF">-</text>
  
  <text x="570" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#FCD34D">Only modified blocks stored</text>
  
  <!-- Arrow from Base to COW area -->
  <path d="M350 150 L350 175" stroke="#60A5FA" stroke-width="2" marker-end="url(#arrow)"/>
  
  <!-- Read Flow -->
  <rect x="50" y="430" width="340" height="150" rx="8" fill="#1F2937" stroke="#34D399" stroke-width="2"/>
  <text x="220" y="455" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#34D399">READ Operation</text>
  
  <text x="70" y="480" font-family="Arial, sans-serif" font-size="11" fill="#D1D5DB">1. Check overlay for block</text>
  <text x="70" y="500" font-family="Arial, sans-serif" font-size="11" fill="#D1D5DB">2. If in overlay → return overlay data</text>
  <text x="70" y="520" font-family="Arial, sans-serif" font-size="11" fill="#D1D5DB">3. If not → read from base device</text>
  <text x="70" y="545" font-family="Arial, sans-serif" font-size="10" fill="#6B7280">Result: Merged view of base + changes</text>
  
  <!-- Write Flow -->
  <rect x="410" y="430" width="340" height="150" rx="8" fill="#1F2937" stroke="#F59E0B" stroke-width="2"/>
  <text x="580" y="455" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#F59E0B">WRITE Operation</text>
  
  <text x="430" y="480" font-family="Arial, sans-serif" font-size="11" fill="#D1D5DB">1. Write always goes to overlay</text>
  <text x="430" y="500" font-family="Arial, sans-serif" font-size="11" fill="#D1D5DB">2. Stored in IndexedDB</text>
  <text x="430" y="520" font-family="Arial, sans-serif" font-size="11" fill="#D1D5DB">3. Base image unchanged</text>
  <text x="430" y="545" font-family="Arial, sans-serif" font-size="10" fill="#6B7280">Result: Persistent, exportable changes</text>
  
  <!-- Benefits -->
  <text x="400" y="595" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#9CA3AF">✓ Original disk unmodified  ✓ Changes persist in browser  ✓ Export only changed blocks  ✓ Multiple VMs share base</text>
</svg>
